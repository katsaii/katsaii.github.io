<!DOCTYPE html>
<!-- AUTO GENERATED BY KAT/KATSAII -->

<html lang="en">
	<head>
		<meta charset="utf-8">
<meta name="author" content="Kat @katsaii">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/image/logo-mini.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link rel="stylesheet" href="/style/root.css">
<script defer src="/script/root.js"></script>

		<meta name="description" content="By replacing global variables with functions that return static data structures, common variable reference pitfalls can be avoided in GameMaker Language (GML).">
		<link rel="stylesheet" href="/style/post.css">
		<title>Writing Safer Global Variables in GameMaker Studio 2</title>
	</head>
	<body>
		<div id="homepage" class="sidebar">
	<a href="/" draggable="false"><img class="avatar" src="/image/logo.png" draggable="false" /></a>
	<br>
	<a href="/content/blog/posts.html">Blog</a> | <a href="/">Home</a>
	<br>
	<button class="unstyled" onclick="enable_darkmode()">
		<img id="bulb" class="avatar" src="/image/bulb.png" draggable="false" />
	</button>
</div>

		<div id="index" class="sidebar">
			<div>
				<b>Contents</b>
				
					<i>(<a href="/content/blog/tldr/safer+gml+globals.html">TL;DR</a>)</i>
				
			</div>
			<div class="h1"><a href="#">Writing Safer Global Variables in GameMaker Studio 2</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#preface">Preface</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#the+problem+with+global+variables+in+gml">The Problem with Global Variables in GML</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#initialisation+rooms">Initialisation Rooms</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#global+scripts">Global Scripts</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#checking+if+the+variable+exists">Checking If the Variable Exists</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#static+variables">Static Variables</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#modifying+static+variables">Modifying Static Variables</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#replacing+global+variables+with+static+variables">Replacing Global Variables with Static Variables</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#summary">Summary</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#references">References</a></div>
			
		</div>
		<div id="content">
			<div id="header">
				<h1>Writing Safer Global Variables in GameMaker Studio 2</h1>
				
					<span class="date">27th Jan 2022</span>
				
			</div>
			<div class="justify">
				
					<p>By replacing global variables with functions that return static data structures, common variable reference pitfalls can be avoided in GameMaker Language (GML).</p>
				
				<hr>
				<h2 id="preface"><a href="#preface">§</a> Preface</h2>
<p>My intention with this post is not to preach a &quot;<a href="https://youtu.be/gc8mDZwUlfo?t=69s">best practice</a>;&quot; I just wanted to talk about one method of managing global state that I find useful. Just like with any problem, you should always consider different approaches based on your current priorities. <code>d (u _ u.)\</code></p>
<h2 id="the+problem+with+global+variables+in+gml"><a href="#the+problem+with+global+variables+in+gml">§</a> The Problem with Global Variables in GML</h2>
<p>Plenty of articles describe some (of many) reasons why you should try to avoid global variables, typically because they can make reasoning about programs difficult<sup class="footnote-ref"><a href="#fn-wiki-glob" id="fnref-wiki-glob" data-footnote-ref>1</a></sup>. However, I'm not concerned with discussing those problems within this post. Instead, I want to cover the situations where some value <em>really needs to be global</em>.</p>
<p>So what is the problem? In GML, global variables are only created the instant they're assigned a value at runtime. So, if your global variable definitions are hidden away inside some script or object that the game never reaches, then those global variables will never exist. For example, in the following code the global variable <code>name</code> gets defined before <code>colour</code>, and the global variable <code>hidden</code> is never defined:</p>
<pre><code class="hl"><span class="kc">global</span><span class="o">.</span><span class="nb">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s">"Kirby"</span><span class="p">;</span><span class="w">  </span><span class="c1">// global.name is defined first</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nb">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0xcbc0ff</span><span class="p">;</span><span class="w"> </span><span class="c1">// global.colour is defined second</span><span class="w">

</span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// this return statement will prevent</span><span class="w">
        </span><span class="c1">// any code below it from executing</span><span class="w">

</span><span class="c1">// because this line is never reached</span><span class="w">
</span><span class="c1">// the global variable is never defined</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nv">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"(O x O) help!"</span><span class="p">;</span><span class="w">
</span></code></pre>
<p>Attempting to access the <code>hidden</code> global variable will raise an error telling you that the global variable doesn't exist! This behaviour can become a problem if one part of your game depends on a global variable being declared some place else in your project.</p>
<p>Lets imagine a project with two objects:</p>
<ul>
<li><code>obj_control</code>, which initialises a global variable; and</li>
<li><code>obj_player</code>, which uses the global variable that <code>obj_control</code> declares.</li>
</ul>
<p>In order to avoid an error in your game, you <strong>need to guarantee</strong> that the <code>obj_control</code> object is created before <code>obj_player</code>, otherwise <code>obj_player</code> may try to access the global variable before it exists. This can be a particularly annoying bug to track down if it (seemingly) occurs randomly, which is not unlikely if you depend on the creation order of instances in rooms.</p>
<h3 id="initialisation+rooms"><a href="#initialisation+rooms">§§</a> Initialisation Rooms</h3>
<p>One common method of patching this bug is to have a so-called &quot;initialisation room,&quot; where short-lived objects declare your global variables. Although this solution works fine, it can be brittle because it relies on trust; trusting developers to add any newly introduced global variables to this special room. This is not a big issue, since if you encounter an error relating to a global variable being unset, then the solution is likely to be to add this variable to the initialisation room. However, it is a flaw with this system that I thought was worth mentioning.</p>
<h3 id="global+scripts"><a href="#global+scripts">§§</a> Global Scripts</h3>
<p>In a similar way to initialisation rooms, script resources can be used to initialise any global variables. This is possible since all code inside script resources is executed before you even enter the first room of your game. However, because the execution order of this system is not predictable, global variables from one script should <strong>never</strong> depend on any global variables from other scripts, otherwise you may encounter situations where the global variable a script depends on has not been initialised yet.</p>
<h3 id="checking+if+the+variable+exists"><a href="#checking+if+the+variable+exists">§§</a> Checking If the Variable Exists</h3>
<p>Another potential approach would be to check if the global variable exists, using the <code>variable_global_exists</code> function, before you attempt to access it, like so:</p>
<pre><code class="hl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nb">variable_global_exists</span><span class="p">(</span><span class="s">"highscore"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// initialise the variable if it is unset</span><span class="w">
  </span><span class="kc">global</span><span class="o">.</span><span class="nv">highscore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">// you are now allowed to access highscore here safely</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">yay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">global</span><span class="o">.</span><span class="nv">highscore</span><span class="p">;</span><span class="w">
</span></code></pre>
<p>Unfortunately, there is a clear ergonomic issue with this approach: the code repeats the name of the global variable (<code>highscore</code>) too often. If the plan is to use this pattern for every global variable, then there is going to be a lot of repeating code.</p>
<p>Ergonomic issues aside, duplicating this code in many places is not a good idea either. (Yes, even if you squeeze it all onto a single line.) Instead, new functions can be defined that handle the &quot;getting&quot; and &quot;setting&quot; of the global variable automatically:</p>
<pre><code class="hl"><span class="c1">// note:</span><span class="w">
</span><span class="c1">// these functions should be defined inside of a script</span><span class="w">
</span><span class="c1">// so that they are available globally to all objects</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">get_highscore</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nb">variable_global_exists</span><span class="p">(</span><span class="s">"highscore"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kc">global</span><span class="o">.</span><span class="nv">highscore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="kc">global</span><span class="o">.</span><span class="nv">highscore</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">set_highscore</span><span class="p">(</span><span class="nb">score</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="kc">global</span><span class="o">.</span><span class="nv">highscore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">score</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Now <code>get_highscore()</code> can be called in any object, at any time, and the global variable will be initialised on-demand if it hasn't already. The initialisation code can be as complicated or as simple as you need it to be, and it will only ever be executed once.</p>
<p>I like this solution, but it's far from perfect. It's somewhat unrealistic to define unique &quot;getter&quot; and &quot;setter&quot; functions for every global variable that may be used in a codebase. Additionally, <code>global.highscore</code> still exists and is accessible, potentially inviting other contributers to use this variable and reintroduce the bugs that were originally trying to be avoided. As a team, you <em>could</em> agree to not use this specific global variable, or you <em>could</em> obfuscate its name to make accessing it less likely, but I feel like it's possible to do better by using a new feature of GML 2.3: static variables...</p>
<h2 id="static+variables"><a href="#static+variables">§</a> Static Variables</h2>
<p>Static variables are new type of variable introduced in version 2.3 of GML. Static variables and global variables are somewhat similar: both will stick around until you end the program. There are two useful differences between them, however:</p>
<ul>
<li>static variables can only be accessed from within the functions they are defined in; and</li>
<li>static variables are only ever initialised once, the first time the function that they were defined in is called.</li>
</ul>
<p>Any subsequent calls to the function will just ignore the initialisation code of any static variables it contains. These features make it possible for functions to maintain their own kind of internal state; for example, a function that counts up from zero:</p>
<pre><code class="hl"><span class="k">function</span><span class="w"> </span><span class="nf">counter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// declare the static variable</span><span class="w">
  </span><span class="k">static</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">

  </span><span class="c1">// increment the count variable</span><span class="w">
  </span><span class="k">var</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">count</span><span class="p">;</span><span class="w">
  </span><span class="nv">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">

  </span><span class="c1">// return the current count</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="nv">current</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Calling the <code>counter</code> function repetitively will yield different results each time:</p>
<pre><code class="hl"><span class="k">var</span><span class="w"> </span><span class="nv">zero</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">counter</span><span class="p">();</span><span class="w"> </span><span class="c1">// 0</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">one</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nf">counter</span><span class="p">();</span><span class="w"> </span><span class="c1">// 1</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">two</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nf">counter</span><span class="p">();</span><span class="w"> </span><span class="c1">// 2</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">counter</span><span class="p">();</span><span class="w"> </span><span class="c1">// 3</span><span class="w">
</span></code></pre>
<h3 id="modifying+static+variables"><a href="#modifying+static+variables">§§</a> Modifying Static Variables</h3>
<p>The ability for static variables to be automatically initialised if they have not yet been is a neat feature. If it were possible to modify the value of a static variable from outside of its enclosing function, then this would erase the need to use the <code>variable_global_exists</code> pattern. Unfortunately, because static variables can only be assigned to from within their enclosing function, workarounds need to be used.</p>
<p>One way to modify the value of a static variable would be to pass in a parameter to its enclosing function. This parameter, if passed, would indicate that the value should be updated:</p>
<pre><code class="hl"><span class="k">function</span><span class="w"> </span><span class="nf">game_title</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">static</span><span class="w"> </span><span class="nv">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Witch Wanda"</span><span class="p">;</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">argument_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">// update the static variable if an argument was passed</span><span class="w">
    </span><span class="nv">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">argument</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="nv">title</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Updating the static variable may then be done like so:</p>
<pre><code class="hl"><span class="k">var</span><span class="w"> </span><span class="nv">currentTitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">game_title</span><span class="p">();</span><span class="w">    </span><span class="c1">// get the current title</span><span class="w">
</span><span class="nf">game_title</span><span class="p">(</span><span class="nv">currentTitle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"izard"</span><span class="p">);</span><span class="w"> </span><span class="c1">// set the new title</span><span class="w">
</span></code></pre>
<p>This pattern is useful if you need to directly modify the value of a static variable, but results in quite a lot of boilerplate code for just one value.</p>
<p>Another method of modifying the contents of a static variable involves <em>reference types</em>. (Things like arrays, or struct instances.) If the value of a static variable is a reference to a data structure, and that reference is returned by the enclosing function, then it is possible to modify the contents of the static variable by modifying the data structure through its reference. For example, creating a static variable that stores a reference to an array data structure:</p>
<pre><code class="hl"><span class="k">function</span><span class="w"> </span><span class="nf">witches</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">static</span><span class="w"> </span><span class="nv">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"Ashley"</span><span class="p">,</span><span class="w"> </span><span class="s">"Marisa"</span><span class="p">,</span><span class="w"> </span><span class="s">"Wanda"</span><span class="p">];</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="nv">names</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The <code>witches</code> function returns a reference to the <code>names</code> array. This reference can be used to modify the elements of the array, so that a new witch is added to the list:</p>
<pre><code class="hl"><span class="k">var</span><span class="w"> </span><span class="nv">namesRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">witches</span><span class="p">();</span><span class="w">
</span><span class="nv">namesRef</span><span class="p">[</span><span class="o">@</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Gruntilda"</span><span class="p">;</span><span class="w">
</span></code></pre>
<p>After this operation, the value of <code>names</code> will now be the array <code>[&quot;Ashley&quot;, &quot;Marisa&quot;, &quot;Wanda&quot;, &quot;Gruntilda&quot;]</code>.</p>
<h2 id="replacing+global+variables+with+static+variables"><a href="#replacing+global+variables+with+static+variables">§</a> Replacing Global Variables with Static Variables</h2>
<p>We're in the endgame, now. So I'll try to keep this last section brief.</p>
<p>Both of the methods of modifying static variables, shown in the previous section, are useful in their own ways. However, the last method can result in more familiar syntax if used with a struct data structure. For example, defining a static struct that stores the current score and highscore is quite simple:</p>
<pre><code class="hl"><span class="k">function</span><span class="w"> </span><span class="nf">scores</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">static</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">// initialise the default values</span><span class="w">
    </span><span class="nv">current</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nv">highscore</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="p">};</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="nv">data</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Accessing and modifying these values greatly resembles the &quot;shape&quot; of <code>global</code> variables:</p>
<pre><code class="hl"><span class="c1">// static variables</span><span class="w">
</span><span class="nf">scores</span><span class="p">()</span><span class="o">.</span><span class="nv">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span><span class="nf">scores</span><span class="p">()</span><span class="o">.</span><span class="nv">highscore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">

</span><span class="c1">// global variables</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nv">scoresCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nv">scoresHighscore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">
</span></code></pre>
<p>Since this pattern doesn't introduce much boilerplate code, it is relatively effortless to adopt. Personally, five more lines is a small price to pay in order to guarantee that your global variables will be declared when they are needed!</p>
<h2 id="summary"><a href="#summary">§</a> Summary</h2>
<p>This post has covered a pitfall with global variables in GML, and proposed various methods of dealing with this issue. Covered in detail is a method involving static variables, describing: what static variables are; how they can be modified; and how a simple pattern can be used to imitate the &quot;shape&quot; and behaviour of global variables, whilst also providing guarantees that certain data will be initialised when requested.</p>
<h2 id="references"><a href="#references">§</a> References</h2>
<section class="footnotes" data-footnotes>
<ol>
<li id="fn-wiki-glob">
<p>WikiWikiWeb. GlobalVariablesAreBad. In <i>CategoryScope</i>. 2013. Retrieved 2022-01-10, <a class="ref-url" href="https://wiki.c2.com/?GlobalVariablesAreBad">https://wiki.c2.com/?GlobalVariablesAreBad</a>. <a href="#fnref-wiki-glob" class="footnote-backref" data-footnote-backref aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>

			</div>
			<div id="footer">
				<div class="centre">
					<b>Thank you for reading!</b>
					<br>
					<code>(.@ w @.) b</code>
				</div>
			</div>
		</div>
	</body>
</html>
