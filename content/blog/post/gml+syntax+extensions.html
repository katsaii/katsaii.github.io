<!DOCTYPE html>
<!-- AUTO GENERATED BY KAT/KATSAII -->

<html lang="en">
	<head>
		<meta charset="utf-8">
<meta name="author" content="Kat @katsaii">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/image/logo-mini.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link rel="stylesheet" href="/style/root.css">
<script defer src="/script/root.js"></script>

		<meta name="description" content="Using bad practices, careful design and creativity, macros can become a powerful feature for introducing new syntax into GameMaker Language (GML).">
		<link rel="stylesheet" href="/style/post.css">
		<title>Misusing Macros to Create Syntax Extensions in GameMaker Studio 2</title>
	</head>
	<body>
		<div id="homepage" class="sidebar">
	<a href="/" draggable="false"><img class="avatar" src="/image/logo.png" draggable="false" /></a>
	<br>
	<a href="/content/blog/posts.html">Blog</a> | <a href="/">Home</a>
	<br>
	<button class="unstyled" onclick="enable_darkmode()">
		<img id="bulb" class="avatar" src="/image/bulb.png" draggable="false" />
	</button>
</div>

		<div id="index" class="sidebar">
			<div>
				<b>Contents</b>
				
					<i>(<a href="/content/blog/tldr/gml+syntax+extensions.html">TL;DR</a>)</i>
				
			</div>
			<div class="h1"><a href="#">Misusing Macros to Create Syntax Extensions in GameMaker Studio 2</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#preface">Preface</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#a+brief+introduction+to+macros">A Brief Introduction to Macros</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#the+precedence+problem">The Precedence Problem</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#the+hygiene+problem">The Hygiene Problem</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#keyword+aliases">Keyword Aliases</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#overriding+built-in+functions">Overriding Built-In Functions</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#custom+statements">Custom Statements</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#ignore">Ignore</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#defer">Defer</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#print">Print</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#custom+operators">Custom Operators</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#boolean+implication">Boolean Implication</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#sequential+composition">Sequential Composition</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#summary">Summary</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#references">References</a></div>
			
		</div>
		<div id="content">
			<div id="header">
				<h1>Misusing Macros to Create Syntax Extensions in GameMaker Studio 2</h1>
				
					<span class="date">16th Dec 2020</span>
				
			</div>
			<div class="justify">
				
					<p>Using bad practices, careful design and creativity, macros can become a powerful feature for introducing new syntax into GameMaker Language (GML).</p>
				
				<hr>
				<h2 id="preface"><a href="#preface">§</a> Preface</h2>
<p>The aim of this post isn't to explore whether using macros as syntax extensions is practical, beneficial, or even a good idea. Rather, this post is designed to make these ideas known to those who are interested. Basic approaches to creating such syntax extensions are outlined throughout the post.</p>
<p>Note: although macros are styled in <code>SCREAMING_SNAKE_CASE</code> by convention, all macro definitions in this post that resemble keywords will be in <code>snake_case</code>.</p>
<h2 id="a+brief+introduction+to+macros"><a href="#a+brief+introduction+to+macros">§</a> A Brief Introduction to Macros</h2>
<p>This post assumes basic knowledge of what macros are, but for those that want a quick introduction: macros act as instructions to search for and replace some piece of code with another. Macros do not exist once the program is compiled, as they disappear once their job is done. More specifically, macros are a form of <em>compiler directive</em> or <em>preprocessor directive</em> that enable developers to assign symbols to pieces of (commonly used) source code. As the name suggests, these constructs perform their tasks before or during compile-time, hence their disappearance once the build process of the program is complete.</p>
<p>Macros in GML use the <code>#macro</code> directive, and function similarly to C macros. The most common application of macros in GML is to give synonyms to constants. Consider the following macro definition</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">MESSAGE</span><span class="w"> </span><span class="s">"hello world"</span><span class="w">
</span></code></pre>
<p>The symbol <code>MESSAGE</code> is the macro identifier and <code>&quot;hello world&quot;</code> is the piece of source code that the macro represents. Upon compilation, all occurrences of <code>MESSAGE</code> will be replaced with <code>&quot;hello world&quot;</code>.</p>
<p>The following sub-sections detail common pitfalls to macros that can be exploited in GML.</p>
<h3 id="the+precedence+problem"><a href="#the+precedence+problem">§§</a> The Precedence Problem</h3>
<p>The term &quot;precedence problem&quot; has been borrowed from the official GNU C docs<sup class="footnote-ref"><a href="#fn-macro" id="fnref-macro" data-footnote-ref>1</a></sup>. I'm a fan of this term because it clearly describes what the issue involves! Consider the following macro</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">PRICE</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="w">
</span></code></pre>
<p>Now suppose it is used in an expression such as</p>
<pre><code class="hl"><span class="k">var</span><span class="w"> </span><span class="nv">tax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="vm">PRICE</span><span class="p">;</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="s">"VAT: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nv">tax</span><span class="p">));</span><span class="w">
</span></code></pre>
<p>At first glance, the expected value of <code>tax</code> might be <code>2.6</code> since <code>20%</code> of <code>13</code> (<code>5 + 8</code>) is <code>2.6</code>. However, this is not the case. In fact, the value of <code>tax</code> ends up being <code>4</code>! The reason for this is that the macro <code>PRICE</code> interferes with the precedence of the expression. The compiler will expand the expression <code>0.2 * PRICE</code> into <code>0.2 * 5 + 8</code>, not <code>0.2 * (5 + 8)</code>. This can be problematic if not identified by the developer, as this behaviour can lead to difficult to diagnose bugs. To avoid this issue, the content of the <code>PRICE</code> macro should be wrapped in a grouping:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">PRICE</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></code></pre>
<p>Running this program again produces the desired result of <code>2.6</code>.</p>
<p>So how is this useful? There is some power here that can be exploited. For example, let an array <code>p</code> of player positions be of the form <code>[x1, y1, x2, y2, ...]</code>. To index this array and retrieve the x and y position of some player with the id of <code>i</code>, the following code may be used:</p>
<pre><code class="hl"><span class="k">var</span><span class="w"> </span><span class="nv">posX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">[</span><span class="nv">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">posY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">[</span><span class="nv">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">
</span></code></pre>
<p>This code is clean, but macros may be used to help the code explain itself more clearly:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">X</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="vm">Y</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">

</span><span class="k">var</span><span class="w"> </span><span class="nv">posX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">[</span><span class="nv">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="vm">X</span><span class="p">];</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">posY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">[</span><span class="nv">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="vm">Y</span><span class="p">];</span><span class="w">
</span></code></pre>
<p>The macros <code>X</code> and <code>Y</code> can be thought of as &quot;units&quot; that apply some sort of transformation to the value <code>i</code>. The benefit of doing this the same reason macros are useful in the first place: potential human error in the source code can be reduced by reducing code duplication.</p>
<p>Although this example was cherry-picked, it does illustrate a practical use for this sort of behaviour.</p>
<h3 id="the+hygiene+problem"><a href="#the+hygiene+problem">§§</a> The Hygiene Problem</h3>
<p>&quot;Hygiene&quot; with respect to macros refers to the possibility of macros strangely interacting with the program state outside of its definition. In other words, non-hygienic macros can create and access variables from outside of their scope. Consider the following example</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">ENTER_BUNNY</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nv">bunny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/(.U x U.) &lt;(yuh)"</span><span class="w">

</span><span class="vm">ENTER_BUNNY</span><span class="p">;</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="nv">bunny</span><span class="p">);</span><span class="w"> </span><span class="c1">// ???</span><span class="w">
</span></code></pre>
<p>If macros in GML were hygienic, this code would complain that the variable <code>bunny</code> does not exist. However, the compiler just expands the <code>ENTER_BUNNY</code> macro and everything becomes balanced in the world:</p>
<pre><code class="hl"><span class="k">var</span><span class="w"> </span><span class="nv">bunny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/(.U x U.) &lt;(yuh)"</span><span class="p">;</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="nv">bunny</span><span class="p">);</span><span class="w">
</span></code></pre>
<p>Macros are purposefully designed to be &quot;dumb&quot; in this way. They don't care about whether the syntax is valid or whether a variable is in scope, they just do their job and disappear.</p>
<p>Non-hygienic macros can be a useful tool for creating stateful macro definitions. Below is an example set of macros that return different names of fruit:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">FRUIT_BEGIN</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nv">fruits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"pear"</span><span class="p">,</span><span class="w"> </span><span class="s">"grape"</span><span class="p">,</span><span class="w"> </span><span class="s">"apple"</span><span class="p">,</span><span class="w"> </span><span class="s">"mango"</span><span class="p">]</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="vm">FRUIT_OF_THE_DAY</span><span class="w"> </span><span class="nv">fruits</span><span class="p">[</span><span class="nb">irandom</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span><span class="w">

</span><span class="vm">FRUIT_BEGIN</span><span class="p">;</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="vm">FRUIT_OF_THE_DAY</span><span class="p">);</span><span class="w"> </span><span class="c1">// pear</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="vm">FRUIT_OF_THE_DAY</span><span class="p">);</span><span class="w"> </span><span class="c1">// mango</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="vm">FRUIT_OF_THE_DAY</span><span class="p">);</span><span class="w"> </span><span class="c1">// apple</span><span class="w">
</span><span class="nb">show_message</span><span class="p">(</span><span class="vm">FRUIT_OF_THE_DAY</span><span class="p">);</span><span class="w"> </span><span class="c1">// mango</span><span class="w">
</span></code></pre>
<h2 id="keyword+aliases"><a href="#keyword+aliases">§</a> Keyword Aliases</h2>
<p>A relatively simple class of syntax extensions (that can be created using macros) are aliases for existing keywords. For example, let's say a developer wants to use the word <code>elif</code> in place of any instance of <code>else if</code>. This can be achieved by creating a macro that maps from the synonym <code>elif</code> to the phrase <code>else if</code>; any occurrences of <code>elif</code> in the developer's codebase will behave as though <code>else if</code> were written instead:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">elif</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w">

</span><span class="k">var</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"yes"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="k">elif</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"no"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"maybe (.O _ O.)"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<br>
<p>This sort of syntax extension is not particularly useful when applied to keywords. However, the same approach can be used with built-in constants and built-in functions! If a developer desires a shorter version of an existing function, then they can make use of macros to do so. For example, creating a shorter alias, <code>log</code>, for <code>show_debug_message</code>:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="nv">log</span><span class="w"> </span><span class="nb">show_debug_message</span><span class="w">

</span><span class="nf">log</span><span class="p">(</span><span class="s">"wow, cool"</span><span class="p">);</span><span class="w">
</span></code></pre>
<p>Although creating aliases for long functions is already quite useful, the next sub-section covers a wildly more useful feature of macros: overriding functions.</p>
<h3 id="overriding+built-in+functions"><a href="#overriding+built-in+functions">§§</a> Overriding Built-In Functions</h3>
<p>One little known feature of macros is the ability to override built-in functions with a custom implementation. A particularly useful case for this is overriding <code>show_debug_message</code> so that it writes to a log file, rather than to the IDE console window. The process of logging debug messages to a file (or leaving &quot;breadcrumbs&quot;) is very important for debugging issues encountered by users. This behaviour can be achieved by creating a macro where the function you want to override is the name of the macro:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="nb">show_debug_message</span><span class="w"> </span><span class="nv">overrides_show_debug_message</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">overrides_show_debug_message</span><span class="p">(</span><span class="nv">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">var</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">file_text_open_append</span><span class="p">(</span><span class="s">"game.log"</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_write_string</span><span class="p">(</span><span class="nv">file</span><span class="p">,</span><span class="w"> </span><span class="nv">str</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_writeln</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_close</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>With this macro, any occurrences of <code>show_debug_message</code> will be replaced with <code>overrides_show_debug_message</code>. This results in all debug messages being written to an external file named <code>&quot;game.log&quot;</code>. However, be warned! Since all occurrences of <code>show_debug_message</code> are now replaced with the overriding function, any instance of <code>show_debug_message</code> inside the body of that function will cause it to enter an infinite loop (if not handled correctly). This is not immediately obvious, especially if the macro definition is in a separate file. For this reason, it's a pitfall to be aware of.</p>
<p>This same approach can be applied to other parts of GML, such as with built-in variables or constants. For example, the default colour for the literal, <code>c_red</code>, is very ugly, but it can be overridden to a <a href="https://www.color-hex.com/color/d15864">better shade</a> using a macro:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="kc">c_red</span><span class="w"> </span><span class="nb">make_colour_rgb</span><span class="p">(</span><span class="mi">209</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">
</span></code></pre>
<p>As always, <code>c_red</code> will be replaced by the snippet of code, <code>make_colour_rgb(209, 88, 100)</code>.</p>
<h2 id="custom+statements"><a href="#custom+statements">§</a> Custom Statements</h2>
<p>Moving on from simple keyword aliases. This section covers three custom statements and walks through the different techniques of deriving them.</p>
<h3 id="ignore"><a href="#ignore">§§</a> Ignore</h3>
<p>The first statement that has been <a href="https://twitter.com/katsaii/status/1583541827529244672">conjured up</a> is <code>ignore</code>. The <code>ignore</code> statement is a simple construct with the power to prevent a block of code from being executed at runtime. This behaves somewhat similarly to comments, except syntax highlighting and IDE auto-completion are allowed. The example below pictures the ignore statement preventing an infinite loop, <code>while (true)</code>, from occurring:</p>
<pre><code class="hl"><span class="nb">show_message</span><span class="p">(</span><span class="s">"this is shown"</span><span class="p">);</span><span class="w">
</span><span class="k">ignore</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"this is ignored"</span><span class="p">);</span><span class="w">
  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">// repeat forever</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>A common method of achieving this functionality is to replace <code>ignore</code> with <code>if (false)</code>, so perhaps this should also be the definition of <code>ignore</code>? For most intents and purposes that would be correct. However, according to that definition of <code>ignore</code>, the following snippet of code is valid:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">ignore</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w">

</span><span class="k">ignore</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"ignore me"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nf">get_funky</span><span class="p">();</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Does it make sense for there to be an <code>else</code> clause on <code>ignore</code>, and if so, what would that even mean? Ideally, <code>ignore</code> should act by itself without allowing additional modifiers.</p>
<p>At this point, a little more creativity is needed. Of course, <code>if (false)</code> is not the only method of creating unreachable code. Other examples are shown below.</p>
<pre><code class="hl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// ignore</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// ignore</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="kc">false</span><span class="p">;)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// ignore</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="k">repeat</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// ignore</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="k">with</span><span class="w"> </span><span class="p">(</span><span class="kc">noone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// ignore</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w">
  </span><span class="k">break</span><span class="p">;</span><span class="w">
</span><span class="k">default</span><span class="o">:</span><span class="w">
  </span><span class="c1">// ignore</span><span class="w">
  </span><span class="k">break</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>At first glance, most of these options seem useful. However, two options completely outperform the rest: <code>if (true) { } else</code> and <code>for (;false;)</code>. This is because <code>while</code>, <code>until</code>, <code>repeat</code> and <code>with</code> statements are all susceptible to the same &quot;attack;&quot; that is, a partial expression, such as <code>|| true</code>, can be used to force the condition to evaluate to <code>true</code>. Thus unreachable code is suddenly able to be accessed. The benefit of <code>if (true) { } else</code> and <code>for (;false;)</code> is that neither of these candidates exposes a way for an external user to apply this attack. Specifically, <code>for</code> loops in GML are the only construct that requires a top-level grouping <code>()</code>, and <code>else</code> does not include a condition to exploit in the first place. Either one of these approaches will suit the <code>ignore</code> macro nicely. Ultimately, <code>if (true) { } else</code> was used in the following illustration for readability purposes:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">ignore</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w">

</span><span class="k">ignore</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"ignore me"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c1">// putting an `else` here will result in a syntax error, as intended</span><span class="w">
</span></code></pre>
<p>There you have it! A full-fat syntax extension that adds a new kind of statement to the language.</p>
<p>The next sub-section covers the <code>defer</code> statement, and how a sneaky feature of <code>for</code> loops can be exploited to implement this language feature.</p>
<h3 id="defer"><a href="#defer">§§</a> Defer</h3>
<p>The second syntax extension this post will present is <code>defer</code>. A <code>defer</code> statement is a common kind of statement used in some systems programming languages. Its functionality involves delaying the execution of a segment of code until the end of its scope. The primary use of this is to clean up any resources once they go out of scope. This behaviour can be imitated in GML by including an additional <code>after</code> clause:</p>
<pre><code class="hl"><span class="k">defer</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"me second!"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"me first!"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<br>
<p>There is a very specific way this control flow can be achieved, and it involves a little known feature of <code>for</code> loops. Did you know that the third expression in a <code>for</code> loop can be a block?</p>
<pre><code class="hl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">j</span><span class="p">;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" &lt; "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nv">j</span><span class="p">));</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Notice the incrementor statement <code>{ i += 2; j += 1 }</code> in place of the third expression. This might look strange, but it is valid syntax in GML. What makes this feature so powerful is the fact that the body of the <code>for</code> loop itself gets executed before the third expression in the for loop:</p>
<pre><code class="hl"><span class="k">for</span><span class="w"> </span><span class="p">(;;</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"me second!"</span><span class="p">);</span><span class="w">
  </span><span class="k">break</span><span class="p">;</span><span class="w">
</span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"me first!"</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The <code>break</code> is required to prevent an infinite loop. This is already looking very similar to the proposed <code>defer</code> and <code>after</code> keywords; the snippet <code>for (;; {</code> could represent the <code>defer</code> keyword, and <code>; break; })</code> could represent the <code>after</code> keyword. Together they form the full statement:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">defer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(;;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">})</span><span class="w">

</span><span class="k">var</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">file_text_open_read</span><span class="p">(</span><span class="s">"save.txt"</span><span class="p">);</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="p">;</span><span class="w">
</span><span class="k">defer</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// close the file after it is finished being read</span><span class="w">
  </span><span class="nb">file_text_close</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">// read the content of the file</span><span class="w">
  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nb">file_text_eof</span><span class="p">(</span><span class="nv">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">content</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">file_text_readln</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>This example shows how the <code>defer</code> statement can be used in a practical situation: a text file is opened, its content is read, and then it is closed. This is beneficial because the code that handles the file closure is located near similar code that opens the file. Additionally, if the code for reading the content of the file is more complex, for example spanning hundreds of lines, then bugs caused by human error are certainly going to occur.</p>
<p>In the next sub-section, a <code>print</code> statement will be briefly discussed, including how a similar technique to this can be used to pull values into the body of the macro.</p>
<h3 id="print"><a href="#print">§§</a> Print</h3>
<p>The final syntax extension that will be covered is a <code>print</code> statement. This might sound a bit anticlimactic at first, but it really is the most technical macro of the three. The <code>print</code> statement builds off of the approaches shown in the previous two sub-sections, so this will only be brief. Secretly, the <code>print</code> statement assigns the to-be printed value into a hidden variable. The value of this variable is then output to the console, before <code>break</code> is executed to exit the loop:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">print</span><span class="w">                          </span><span class="o">\</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="nv">printValue</span><span class="p">;;</span><span class="w"> </span><span class="p">{</span><span class="w">           </span><span class="o">\</span><span class="w">
      </span><span class="nb">show_debug_message</span><span class="p">(</span><span class="nv">printValue</span><span class="p">);</span><span class="w"> </span><span class="o">\</span><span class="w">
      </span><span class="k">break</span><span class="p">;</span><span class="w">                          </span><span class="o">\</span><span class="w">
    </span><span class="p">})</span><span class="w"> </span><span class="nv">printValue</span><span class="w"> </span><span class="o">=</span><span class="w">

</span><span class="k">print</span><span class="w"> </span><span class="s">"hello world"</span><span class="p">;</span><span class="w">
</span><span class="k">print</span><span class="w"> </span><span class="mf">7.2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w">
</span><span class="k">print</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="nb">y</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">36</span><span class="w"> </span><span class="p">};</span><span class="w">
</span><span class="k">print</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">undefined</span><span class="p">];</span><span class="w">
</span></code></pre>
<p>The implementation of this macro makes use of the <code>\</code> to continue the definition onto a new line. So-called &quot;multi-line macros&quot; can improve the readability of long macros by breaking them over multiple lines.</p>
<h2 id="custom+operators"><a href="#custom+operators">§</a> Custom Operators</h2>
<p>Up to this point, macros have only been used to create syntax extensions for statements. However, custom operators can be defined in the same way! This section covers two custom binary operators that can be defined using macros.</p>
<h3 id="boolean+implication"><a href="#boolean+implication">§§</a> Boolean Implication</h3>
<p>The first custom operator to be highlighted in this section is the lesser-known logical implication (<code>-&gt;</code>). The operation <code>a -&gt; b</code> is often described in words as: &quot;if <code>a</code> is <code>true</code>, then <code>b</code> is also <code>true</code>.&quot; Thus, if <code>a</code> is <code>true</code>, but <code>b</code> is <code>false</code>, the expression evaluates to <code>false</code>; otherwise, the expression evaluates to <code>true</code>.</p>
<p>Often <code>a -&gt; b</code> is a derived operation defined in terms of Boolean <strong>NOT</strong> (<code>!</code>) and Boolean <strong>OR</strong> (<code>||</code>):</p>
<pre><code class="hl"><span class="nv">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">!</span><span class="nv">a</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">b</span><span class="w">
</span></code></pre>
<p>However, this form cannot be easily translated into a macro, since <code>a</code> occurs between <code>!</code> and <code>||</code>. Luckily, there is a way to get around this issue, and it involves Boolean <strong>XOR</strong> (<code>^^</code>): the term <code>!a</code> is semantically equivalent to <code>a ^^ true</code>. This is because the operation <code>b1 ^^ b2</code> only returns <code>true</code> if neither of the operands, <code>b1</code> or <code>b2</code>, are equal. Since <code>b2</code> always equals <code>true</code>, this has the effect of always returning the negation of <code>a</code>; that is, <code>true ^^ true == false</code> and <code>false ^^ true == true</code>. This knowledge can be used to define a custom binary operator <code>implies</code> in terms of <code>^^</code> and <code>||</code>:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">implies</span><span class="w"> </span><span class="o">^^</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="o">||</span><span class="w">

</span><span class="k">var</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">aimplya</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="k">implies</span><span class="w"> </span><span class="nv">a</span><span class="p">;</span><span class="w"> </span><span class="c1">// true  -&gt; true  = true</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">aimplyb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="k">implies</span><span class="w"> </span><span class="nv">b</span><span class="p">;</span><span class="w"> </span><span class="c1">// true  -&gt; false = false</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">bimplyb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="k">implies</span><span class="w"> </span><span class="nv">b</span><span class="p">;</span><span class="w"> </span><span class="c1">// false -&gt; false = true</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">bimplya</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="k">implies</span><span class="w"> </span><span class="nv">a</span><span class="p">;</span><span class="w"> </span><span class="c1">// false -&gt; true  = true</span><span class="w">
</span></code></pre>
<br>
<p>This same idea can be applied to bitwise operations by instead using <code>^</code> and <code>|</code>:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">bimplies</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">

</span><span class="k">var</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0110</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0101</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">abimplya</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="k">bimplies</span><span class="w"> </span><span class="nv">a</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0110 .-&gt; 0110 = 1111</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">abimplyb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="k">bimplies</span><span class="w"> </span><span class="nv">b</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0110 .-&gt; 0101 = 1101</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">bbimplyb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="k">bimplies</span><span class="w"> </span><span class="nv">b</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0101 .-&gt; 0101 = 1111</span><span class="w">
</span><span class="k">var</span><span class="w"> </span><span class="nv">bbimplya</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="k">bimplies</span><span class="w"> </span><span class="nv">a</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0101 .-&gt; 0110 = 1110</span><span class="w">
</span></code></pre>
<p>Since no variant of <code>true</code> exists in bitwise Boolean algebras, it is defined as the ones' complement (<code>~</code>) of <code>0</code>. This results in a similar implication operator that can be used with bitmasking.</p>
<p>In the next sub-section, a useful operator <code>seq</code> is discussed, which ends up being useful for combining side-effecting expressions.</p>
<h3 id="sequential+composition"><a href="#sequential+composition">§§</a> Sequential Composition</h3>
<p>The second, and final operator to be showcased is a sequential composition operator. Actually, GML already has one of these! It's called the statement terminator <code>;</code>. However, as the name suggests, <code>;</code> is only ever used for statements. This is quite a disadvantage because it means that <code>for</code> loops (<a href="#defer">typically</a>) only allow a single incrementor. If a sequential composition operator, <code>seq</code>, for expressions existed, then <code>for</code> loops with multiple incrementors could be constructed:</p>
<pre><code class="hl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w">
  </span><span class="k">var</span><span class="w"> </span><span class="nv">i</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ds_map_find_first</span><span class="p">(</span><span class="nv">map</span><span class="p">);</span><span class="w">
  </span><span class="nv">key</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span><span class="w">
  </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">i</span><span class="o">++</span><span class="w"> </span><span class="k">seq</span><span class="w"> </span><span class="nb">ds_map_find_next</span><span class="p">(</span><span class="nv">map</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">))</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">show_message</span><span class="p">(</span><span class="s">"the key at index "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" is "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nv">key</span><span class="p">));</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Fortunately, GML has just enough features to make the <code>seq</code> operator on expressions a reality:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="k">seq</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">NaN</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></code></pre>
<p>Simply put: <code>seq</code> is defined as a ternary expression where the true branch is never executed. Therefore, its condition must always evaluate to false. The <code>&amp;&amp; false</code> at the end of the condition ensures this is the case. Additionally, the parenthesis <code>)</code> and <code>(</code> at the start and end of the macro ensures the user wraps the binary operation in a grouping <code>(a seq b)</code>. This is required because of the precedence of ternary operators.</p>
<p>Interestingly, this custom composition operator is functionally similar to the comma operator<sup class="footnote-ref"><a href="#fn-comma" id="fnref-comma" data-footnote-ref>2</a></sup> which appears in JavaScript and C/C++.</p>
<h2 id="summary"><a href="#summary">§</a> Summary</h2>
<p>This post has discussed various macro pitfalls and how they can be utilised to create interesting syntax extensions. These came in the form of key and function aliases, statements and operators. This post also covers how to use macros to override built-in functions or constants with custom implementations.</p>
<h2 id="references"><a href="#references">§</a> References</h2>
<section class="footnotes" data-footnotes>
<ol>
<li id="fn-macro">
<p>The GCC Team. 3.10 - Macro Pitfalls. In <i>The C Processor</i>. Free Software Foundation, Inc, 2020. Retrieved 2021-03-02, <a class="ref-url" href="https://gcc.gnu.org/onlinedocs/cpp/Macro-Pitfalls.html">https://gcc.gnu.org/onlinedocs/cpp/Macro-Pitfalls.html</a>. <a href="#fnref-macro" class="footnote-backref" data-footnote-backref aria-label="Back to content">↩</a></p>
</li>
<li id="fn-comma">
<p>MDN Contributers. Comma Operator (,). In <i>JavaScript Reference</i>. Mozilla, 2020. Retrieved 2021-03-02, <a class="ref-url" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Comma_Operator">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Comma_Operator</a>. <a href="#fnref-comma" class="footnote-backref" data-footnote-backref aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>

			</div>
			<div id="footer">
				<div class="centre">
					<b>Thank you for reading!</b>
					<br>
					<code>(.@ w @.) b</code>
				</div>
			</div>
		</div>
	</body>
</html>
