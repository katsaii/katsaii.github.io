<!DOCTYPE html>
<!-- AUTO GENERATED BY KAT/KATSAII -->

<html lang="en">
	<head>
		<meta charset="utf-8">
<meta name="author" content="Kat @katsaii">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/image/logo-mini.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link rel="stylesheet" href="/style/root.css">
<script defer src="/script/root.js"></script>

		<meta name="description" content="By exploiting an undocumented feature of macros in GameMaker Language (GML), calls to standard library functions can be intercepted in order to help implement missing features.">
		<link rel="stylesheet" href="/style/post.css">
		<title>A Practical Approach to Enriching the Standard Library of GameMaker Studio 2</title>
	</head>
	<body>
		<div id="homepage" class="sidebar">
	<a href="/" draggable="false"><img class="avatar" src="/image/logo.png" draggable="false" /></a>
	<br>
	<a href="/content/blog/posts.html">Blog</a> | <a href="/">Home</a>
	<br>
	<button class="unstyled" onclick="enable_darkmode()">
		<img id="bulb" class="avatar" src="/image/bulb.png" draggable="false" />
	</button>
</div>

		<div id="index" class="sidebar">
			<div>
				<b>Contents</b>
				
					<i>(<a href="/content/blog/tldr/gml+library+extensions.html">TL;DR</a>)</i>
				
			</div>
			<div class="h1"><a href="#">A Practical Approach to Enriching the Standard Library of GameMaker Studio 2</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#preface">Preface</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#the+problem">The Problem</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#the+solution">The Solution</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#implementation+details">Implementation Details</a></div>
			
				<div class="h3"><b>NΞ</b> <a href="#hiding+implementation+details">Hiding Implementation Details</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#experiments">Experiments</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#summary">Summary</a></div>
			
				<div class="h2"><b>NΞ</b> <a href="#references">References</a></div>
			
		</div>
		<div id="content">
			<div id="header">
				<h1>A Practical Approach to Enriching the Standard Library of GameMaker Studio 2</h1>
				
					<span class="date">9th Jun 2021</span>
				
			</div>
			<div class="justify">
				
					<p>By exploiting an undocumented feature of macros in GameMaker Language (GML), calls to standard library functions can be intercepted in order to help implement missing features.</p>
				
				<hr>
				<h2 id="preface"><a href="#preface">§</a> Preface</h2>
<p>This post goes into detail about an undocumented feature of GML, originally brought to my attention by <a href="https://twitter.com/datzach">Zach Reedy</a>. Since this feature is undocumented, it wouldn't be wise to depend entirely on any topics discussed throughout this post, in case something changes in the future or there are inconsistencies between target platforms.</p>
<h2 id="the+problem"><a href="#the+problem">§</a> The Problem</h2>
<p>Like many libraries, there are gaps in the set of built-in functions provided by GameMaker. This is typically due to the low-priority of niche functionality; for instance, there exists functions for setting the minimum and maximum size of the game window<sup class="footnote-ref"><a href="#fn-windowf" id="fnref-windowf" data-footnote-ref>1</a></sup>, but (currently) no functions for getting these values back in case they were updated somewhere else in the codebase.</p>
<p>One method to circumvent this would be to maintain a set of global variables; ones that would store the current minimum and maximum size of the window. These global variables could then be accessed in order to obtain the current window size. The following example illustrates how such an approach could be applied:</p>
<pre><code class="hl"><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">set_min_size</span><span class="p">(</span><span class="nb">width</span><span class="p">,</span><span class="w"> </span><span class="nb">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nb">window_set_min_width</span><span class="p">(</span><span class="nb">width</span><span class="p">);</span><span class="w">
  </span><span class="nb">window_set_min_height</span><span class="p">(</span><span class="nb">height</span><span class="p">);</span><span class="w">
  </span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">width</span><span class="p">;</span><span class="w">
  </span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">height</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>A helper function <code>set_min_size</code> is implemented which sets the minimum size of the window. The corresponding minimum width and height of the window can then be tracked using the global variables <code>windowMinWidth</code> and <code>windowMinHeight</code> respectively. However, this approach only works well if you trust yourself and your collaborators to maintain synchronisation between the global variables and the actual window size. This ultimately requires prohibiting the use of both <code>window_set_min_width</code> and <code>window_set_min_height</code> by team members; any violation of this rule would result in difficult to track bugs.</p>
<h2 id="the+solution"><a href="#the+solution">§</a> The Solution</h2>
<p>An alternative approach to this problem is to use macros to override existing built-in functions, whilst preserving a reference to the original function. In other words, opaquely extending existing built-in functions with additional behaviour; for instance, extending <code>window_set_min_width</code> and <code>window_set_min_height</code> such that their associated global variables get automatically updated:</p>
<pre><code class="hl"><span class="nb">window_set_min_width</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w">  </span><span class="c1">// automatically updates `windowMinWidth` to 100</span><span class="w">
</span><span class="nb">window_set_min_height</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"> </span><span class="c1">// automatically updates `windowMinHeight` to 100</span><span class="w">
</span></code></pre>
<p>In some ways this is superior compared to the previous approach, because it does not prohibit the use of <code>window_set_min_width</code> and <code>window_set_min_height</code>. Everything the <code>set_min_size</code> function did is being performed behind the scenes for the user.</p>
<h3 id="implementation+details"><a href="#implementation+details">§§</a> Implementation Details</h3>
<p>As shown in a <a href="./gml+syntax+extensions.html">previous blog post</a>, built-in functions and variables can be overridden using macros. However, this had limited applications because it caused the original reference to the built-in function to become unreachable. As a result, the original behaviour of the function was lost:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="nb">show_debug_message</span><span class="w"> </span><span class="nv">overrides_show_debug_message</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">overrides_show_debug_message</span><span class="p">(</span><span class="nv">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">var</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">file_text_open_append</span><span class="p">(</span><span class="s">"game.log"</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_write_string</span><span class="p">(</span><span class="nv">file</span><span class="p">,</span><span class="w"> </span><span class="nv">str</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_writeln</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_close</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The <code>show_debug_message</code> typically displays a message in the console window; this example will override the <code>show_debug_message</code> function with a custom implementation that appends the message to a log file. This results in no debug messages being displayed in the console window, since the original functionality has been overwritten. This is not ideal, because the goal was to add additional functionality on top of existing functions, not to replace their functionality entirely; therefore, a method of preserving the reference to the original built-in function is required.</p>
<p>The new method avoids these pitfalls by including an additional macro that acts as a replacement alias for the built-in function. The function definition can then be updated such that both the original and custom implementations of the function are performed:</p>
<pre><code class="hl"><span class="cp">#macro</span><span class="w"> </span><span class="vm">BUILTIN_SHOW_DEBUG_MESSAGE</span><span class="w"> </span><span class="nb">show_debug_message</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="nb">show_debug_message</span><span class="w"> </span><span class="nv">overrides_show_debug_message</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">overrides_show_debug_message</span><span class="p">(</span><span class="nv">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="vm">BUILTIN_SHOW_DEBUG_MESSAGE</span><span class="p">(</span><span class="nv">str</span><span class="p">);</span><span class="w"> </span><span class="c1">// call the original implementation</span><span class="w">
  </span><span class="k">var</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">file_text_open_append</span><span class="p">(</span><span class="s">"game.log"</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_write_string</span><span class="p">(</span><span class="nv">file</span><span class="p">,</span><span class="w"> </span><span class="nv">str</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_writeln</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
  </span><span class="nb">file_text_close</span><span class="p">(</span><span class="nv">file</span><span class="p">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The macro <code>BUILTIN_SHOW_DEBUG_MESSAGE</code> acts as a new alias for the <code>show_debug_message</code> function. This alias is then used within the <code>overrides_show_debug_message</code> function in order to call the original implementation. As a result, the <code>show_debug_message</code> function will now first display the message to the console before writing it to the log file.</p>
<p>Applying this technique to the window example, the following code can be produced:</p>
<pre><code class="hl"><span class="c1">// preserve the original built-in function references</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="vm">BUILTIN_WINDOW_SET_MIN_WIDTH</span><span class="w">  </span><span class="nb">window_set_min_width</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="vm">BUILTIN_WINDOW_SET_MIN_HEIGHT</span><span class="w"> </span><span class="nb">window_set_min_height</span><span class="w">

</span><span class="c1">// override the current function with a custom user-defined function</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="nb">window_set_min_width</span><span class="w">  </span><span class="nv">overrides_window_set_min_width</span><span class="w">
</span><span class="cp">#macro</span><span class="w"> </span><span class="nb">window_set_min_height</span><span class="w"> </span><span class="nv">overrides_window_set_min_height</span><span class="w">

</span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">

</span><span class="c1">// implement function overrides</span><span class="w">
</span><span class="k">function</span><span class="w"> </span><span class="nf">overrides_window_set_min_width</span><span class="p">(</span><span class="nb">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="vm">BUILTIN_WINDOW_SET_MIN_WIDTH</span><span class="p">(</span><span class="nb">width</span><span class="p">);</span><span class="w"> </span><span class="c1">// call the original implementation</span><span class="w">
  </span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">width</span><span class="p">;</span><span class="w">       </span><span class="c1">// update internal record</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="k">function</span><span class="w"> </span><span class="nf">overrides_window_set_min_height</span><span class="p">(</span><span class="nb">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="vm">BUILTIN_WINDOW_SET_MIN_HEIGHT</span><span class="p">(</span><span class="nb">height</span><span class="p">);</span><span class="w">
  </span><span class="kc">global</span><span class="o">.</span><span class="nv">windowMinHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">height</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Using the <code>window_set_min_width</code> and <code>window_set_min_height</code> functions will now automatically update their corresponding global variables, without any additional functions from the perspective of the library user.</p>
<h3 id="hiding+implementation+details"><a href="#hiding+implementation+details">§§</a> Hiding Implementation Details</h3>
<p>Although not strictly required, in the interest of making it difficult to de-synchronise the global variables, the public interface can be restricted; for example, verbose names could be given to the global variables. Their values would then be exposed using shorter, more appealing user-defined getter functions <code>window_get_min_width</code> and <code>window_get_min_height</code>:</p>
<pre><code class="hl"><span class="kc">global</span><span class="o">.</span><span class="nv">__internalWindowVariable_windowMinWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="kc">global</span><span class="o">.</span><span class="nv">__internalWindowVariable_windowMinHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">

</span><span class="k">function</span><span class="w"> </span><span class="nf">window_get_min_width</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="kc">global</span><span class="o">.</span><span class="nv">__internalWindowVariable_windowMinWidth</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="k">function</span><span class="w"> </span><span class="nf">window_get_min_height</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="kc">global</span><span class="o">.</span><span class="nv">__internalWindowVariable_windowMinHeight</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Since getter functions return a copy of the values stored in the global variables, there is no risk of accidentally modifying them, and hence desynchronising their values. This essentially reduces the likelihood of a team member making a mistake, by increasing the effort required to type out the names of protected global variables. Similarly, this could be applied to the macro definitions and function overides in order to coerce users into only using the getter and setter functions.</p>
<p>Note: since many auto-complete engines order underscores after letters alphabetically, any identifiers starting with an underscore will usually appear at the end of the list. This further increases the effort required to make a mistake when using the library.</p>
<h2 id="experiments"><a href="#experiments">§</a> Experiments</h2>
<div class="centre"><div class="inline figure"><a href="/image/figures/pixel-perfect.png" target="_blank" title="enlarge image"><img width="640px" height="auto" alt="Pixel-perfect scaling with a high-resolution GUI layer" src="/image/figures/pixel-perfect.png" /></a><br><div class="centre caption"><b>Figure 1.</b> Pixel-perfect scaling with a high-resolution GUI layer</div></div></div>
<p>A few experiments can be found on <a href="https://github.com/NuxiiGit/macro-hacks/tree/master/gml-library-extensions">GitHub</a> that extend the GameMaker standard library. A list of functions that have been implemented include:</p>
<ul>
<li><code>application_set_position</code> — Enables setting an exact region to render the application surface.</li>
<li><code>application_set_position_fixed</code> — Similar to <code>application_set_position</code>, except preserving aspect ratio.</li>
<li><code>display_set_gui_position</code> — Enables setting an exact region and scale to draw the GUI in.</li>
<li><code>network_get_config</code> — Enables getting network configurations set by the user.</li>
</ul>
<p>All extensions have seen practical use in projects I've been a part of. Most importantly, <code>display_set_gui_position</code> lifts a restriction of the current GUI functions, requiring that either the offset <em>or</em> scale of the GUI could be set, but not both simultaneously<sup class="footnote-ref"><a href="#fn-guif" id="fnref-guif" data-footnote-ref>2</a></sup>. In conjunction with <code>application_set_position_fixed</code>, these extensions allow for low-resolution games to scale &quot;pixel-perfectly,&quot; whilst also enabling a high-resolution GUI. An example of this is shown in Figure 1.</p>
<p>Also included in the repository is a singleton system, which overrides the built-in instance functions in order to prevent multiple singletons of the same type from being created, and to offer deactivation immunity to system objects. This can help reduce the likelihood of bugs related to system objects from occurring.</p>
<h2 id="summary"><a href="#summary">§</a> Summary</h2>
<p>This post has discussed an interesting undocumented feature of macros, and how it can be used to fill gaps within the GameMaker standard library. This approach also shows promise in reducing potential bugs by hiding the job of synchronising global variables with expected inputs to built-in functions.</p>
<h2 id="references"><a href="#references">§</a> References</h2>
<section class="footnotes" data-footnotes>
<ol>
<li id="fn-windowf">
<p>YoYo Games Ltd. 10.2.6.2 - The Game Window. In <i>GameMaker Studio 2 Manual</i>. 2021. Retrieved 2021-06-08, <a class="ref-url" href="https://manual.yoyogames.com/GameMaker_Language/GML_Reference/Cameras_And_Display/The_Game_Window/The_Game_Window.htm">https://manual.yoyogames.com/GameMaker_Language/GML_Reference/Cameras_And_Display/The_Game_Window/The_Game_Window.htm</a>. <a href="#fnref-windowf" class="footnote-backref" data-footnote-backref aria-label="Back to content">↩</a></p>
</li>
<li id="fn-guif">
<p>YoYo Games Ltd. 10.2.6 - <code>display_set_gui_size</code>. In <i>GameMaker Studio 2 Manual</i>. 2021. Retrieved 2021-06-09, <a class="ref-url" href="https://manual.yoyogames.com/GameMaker_Language/GML_Reference/Cameras_And_Display/display_set_gui_size.htm">https://manual.yoyogames.com/GameMaker_Language/GML_Reference/Cameras_And_Display/display_set_gui_size.htm</a>. <a href="#fnref-guif" class="footnote-backref" data-footnote-backref aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>

			</div>
			<div id="footer">
				<div class="centre">
					<b>Thank you for reading!</b>
					<br>
					<code>(.@ w @.) b</code>
				</div>
			</div>
		</div>
	</body>
</html>
